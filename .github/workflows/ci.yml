# GitHub Actions CI Workflow
# Continuous Integration for Infrastructure Validation and Testing
# Runs on pull requests to main branch

name: Infrastructure CI

on:
  pull_request:
    branches:
      - main
    paths:
      - 'modules/**'
      - 'environments/**'
      - 'terragrunt.hcl'
      - '.github/workflows/**'
  push:
    branches:
      - main
    paths:
      - 'modules/**'
      - 'environments/**'
      - 'terragrunt.hcl'
      - '.github/workflows/**'

env:
  TERRAFORM_VERSION: '1.5.7'
  TERRAGRUNT_VERSION: '0.53.0'
  TFLINT_VERSION: 'v0.48.0'

jobs:
  # Job 1: Validate Terraform format
  format-check:
    name: Terraform Format Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Check Terraform format
        run: |
          terraform fmt -check -recursive -diff

  # Job 2: Validate Terraform syntax
  validate:
    name: Terraform Validate
    runs-on: ubuntu-latest
    needs: format-check
    strategy:
      matrix:
        module:
          - resource-group
          - key-vault
          - networking
          - container-instance
          - sql-database
          - virtual-machine
          - log-analytics
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Terraform Init
        working-directory: modules/${{ matrix.module }}
        run: terraform init -backend=false

      - name: Terraform Validate
        working-directory: modules/${{ matrix.module }}
        run: terraform validate

  # Job 3: TFLint - Terraform Linting
  tflint:
    name: TFLint
    runs-on: ubuntu-latest
    needs: format-check
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup TFLint
        uses: terraform-linters/setup-tflint@v4
        with:
          tflint_version: ${{ env.TFLINT_VERSION }}

      - name: Init TFLint
        run: tflint --init

      - name: Run TFLint on modules
        run: |
          for module in modules/*/; do
            echo "Linting $module"
            tflint --chdir="$module" --format=compact
          done

  # Job 4: Security Scanning with Checkov
  security-scan:
    name: Security Scan (Checkov)
    runs-on: ubuntu-latest
    needs: format-check
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Checkov
        run: pip install checkov

      - name: Run Checkov
        run: |
          checkov -d modules/ \
            --framework terraform \
            --output cli \
            --soft-fail \
            --compact

  # Job 5: Security Scanning with tfsec
  tfsec:
    name: Security Scan (tfsec)
    runs-on: ubuntu-latest
    needs: format-check
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run tfsec
        uses: aquasecurity/tfsec-action@v1.0.3
        with:
          soft_fail: true
          format: lovely

  # Job 6: Terragrunt HCL Validate
  terragrunt-validate:
    name: Terragrunt HCL Validate
    runs-on: ubuntu-latest
    needs: [validate, tflint]
    strategy:
      matrix:
        environment: [staging, production]
    env:
      # Mock Azure credentials for validation
      ARM_CLIENT_ID: ${{ secrets.ARM_CLIENT_ID }}
      ARM_CLIENT_SECRET: ${{ secrets.ARM_CLIENT_SECRET }}
      ARM_SUBSCRIPTION_ID: ${{ secrets.ARM_SUBSCRIPTION_ID }}
      ARM_TENANT_ID: ${{ secrets.ARM_TENANT_ID }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
          terraform_wrapper: false

      - name: Setup Terragrunt
        uses: autero1/action-terragrunt@v1.3.2
        with:
          terragrunt_version: ${{ env.TERRAGRUNT_VERSION }}

      - name: Terragrunt HCL Validate
        working-directory: environments/${{ matrix.environment }}
        run: |
          terragrunt hclfmt --terragrunt-check || true
          echo "HCL format check completed"

  # Job 7: Terragrunt Plan (Dry-run)
  terragrunt-plan:
    name: Terragrunt Plan (${{ matrix.environment }})
    runs-on: ubuntu-latest
    needs: [terragrunt-validate, security-scan, tfsec]
    if: github.event_name == 'pull_request'
    strategy:
      matrix:
        environment: [staging]
    env:
      ARM_CLIENT_ID: ${{ secrets.ARM_CLIENT_ID }}
      ARM_CLIENT_SECRET: ${{ secrets.ARM_CLIENT_SECRET }}
      ARM_SUBSCRIPTION_ID: ${{ secrets.ARM_SUBSCRIPTION_ID }}
      ARM_TENANT_ID: ${{ secrets.ARM_TENANT_ID }}
      TF_STATE_RESOURCE_GROUP: ${{ secrets.TF_STATE_RESOURCE_GROUP }}
      TF_STATE_STORAGE_ACCOUNT: ${{ secrets.TF_STATE_STORAGE_ACCOUNT }}
      TF_STATE_CONTAINER: ${{ secrets.TF_STATE_CONTAINER }}
      TF_VAR_unique_suffix: ${{ secrets.TF_VAR_UNIQUE_SUFFIX }}
      TF_VAR_db_admin_username: ${{ secrets.TF_VAR_DB_ADMIN_USERNAME }}
      TF_VAR_db_admin_password: ${{ secrets.TF_VAR_DB_ADMIN_PASSWORD }}
      TF_VAR_dockerhub_username: ${{ secrets.TF_VAR_DOCKERHUB_USERNAME }}
      TF_VAR_dockerhub_password: ${{ secrets.TF_VAR_DOCKERHUB_PASSWORD }}
      TF_VAR_splunk_ssh_public_key: ${{ secrets.TF_VAR_SPLUNK_SSH_PUBLIC_KEY }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
          terraform_wrapper: false

      - name: Setup Terragrunt
        uses: autero1/action-terragrunt@v1.3.2
        with:
          terragrunt_version: ${{ env.TERRAGRUNT_VERSION }}

      - name: Terragrunt Plan
        working-directory: environments/${{ matrix.environment }}
        run: |
          terragrunt run-all plan --terragrunt-non-interactive

      - name: Post Plan Summary
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'âœ… Terragrunt plan for **${{ matrix.environment }}** completed successfully.\n\nðŸ“ Review the Actions logs for detailed plan output.'
            })

  # Job 8: Cost Estimation with Infracost
  cost-estimate:
    name: Cost Estimation
    runs-on: ubuntu-latest
    needs: format-check
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Infracost
        uses: infracost/actions/setup@v3
        with:
          api-key: ${{ secrets.INFRACOST_API_KEY }}

      - name: Generate Infracost diff
        run: |
          infracost breakdown --path=modules/ \
            --format=json \
            --out-file=/tmp/infracost.json || true

      - name: Post Infracost comment
        if: always()
        uses: infracost/actions/comment@v1
        with:
          path: /tmp/infracost.json
          behavior: update
        continue-on-error: true

  # Summary job
  ci-summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [validate, tflint, security-scan, tfsec, terragrunt-validate]
    if: always()
    steps:
      - name: Check CI Status
        run: |
          echo "## CI Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Terraform Validate | ${{ needs.validate.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| TFLint | ${{ needs.tflint.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Scan (Checkov) | ${{ needs.security-scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Scan (tfsec) | ${{ needs.tfsec.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Terragrunt Validate | ${{ needs.terragrunt-validate.result }} |" >> $GITHUB_STEP_SUMMARY
